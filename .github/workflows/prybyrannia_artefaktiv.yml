name: ðŸ§¹ ÐŸÑ€Ð¸Ð±Ð¸Ñ€Ð°Ð½Ð½Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ–Ð²

on:
  schedule:
    # 5 Ñ€Ð°Ð·Ñ–Ð² Ð½Ð° Ð´Ð¾Ð±Ñƒ (Ñ‡ÐµÑ€ÐµÐ· ÐºÐ¾Ð¶Ð½Ñ– 4 Ð³Ð¾Ð´Ð¸Ð½Ð¸ 48 Ñ…Ð²Ð¸Ð»Ð¸Ð½)
    - cron: '48 */4 * * *'
  workflow_dispatch:

jobs:
  cleanup:
    name: ðŸ—‘ï¸ Ð’Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ ÑÑ‚Ð°Ñ€Ð¸Ñ… artefactâ€‘Ñ–Ð²
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§® Ð—Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð·Ð°ÑÑ‚Ð°Ñ€Ñ–Ð»Ñ– artefactâ€‘Ð¸
        uses: actions/github-script@v7
        with:
          script: |
            const maxAgeDays = 3
            const cutoff = Date.now() - maxAgeDays*24*60*60*1000
            const { data } = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            })
            const old = data.artifacts.filter(a => new Date(a.created_at).valueOf() < cutoff)
            core.notice(`Ð¡Ñ‚Ð°Ñ€Ð¸Ñ… artefactâ€‘Ñ–Ð²: ${old.length}`)
            for (const art of old) {
              core.notice(`ðŸ—‘ï¸ Ð’Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ #${art.id} (${art.name})`)
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: art.id
              })
            }
